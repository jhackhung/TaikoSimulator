Microsoft (R) Macro Assembler Version 14.42.34435.0	    12/20/24 02:55:39
main_game_page.asm					     Page 1 - 1


				.686P
				.XMM

				.model flat, c
				include csfml.inc
			      C ; CSFML.INC - SFML Definitions for x86 Assembly
			      C ; 使用 MASM 語法
			      C 
			      C includelib csfml-audio.lib
			      C includelib csfml-graphics.lib
			      C includelib csfml-system.lib
			      C includelib csfml-window.lib
			      C 
			      C ; sfBool 定義
 = 00000000		      C sfFalse     equ 0
 = 00000001		      C sfTrue      equ 1
			      C 
			      C ; sfEventType 定義
 = 00000000		      C sfEvtClosed               equ 0
 = 00000001		      C sfEvtResized              equ 1
 = 00000002		      C sfEvtLostFocus            equ 2
 = 00000003		      C sfEvtGainedFocus          equ 3
 = 00000004		      C sfEvtTextEntered          equ 4
 = 00000005		      C sfEvtKeyPressed           equ 5
 = 00000006		      C sfEvtKeyReleased          equ 6
 = 00000007		      C sfEvtMouseWheelMoved      equ 7
 = 00000008		      C sfEvtMouseWheelScrolled   equ 8
 = 00000009		      C sfEvtMouseButtonPressed   equ 9
 = 0000000A		      C sfEvtMouseButtonReleased  equ 10
 = 0000000B		      C sfEvtMouseMoved           equ 11
 = 0000000C		      C sfEvtMouseEntered         equ 12
 = 0000000D		      C sfEvtMouseLeft            equ 13
			      C 
			      C ; sfMouseButton 定義
 = 00000000		      C sfMouseLeft   equ 0
 = 00000001		      C sfMouseRight  equ 1
 = 00000002		      C sfMouseMiddle equ 2
			      C 
			      C ; sfKey 定義
 = 0000003A		      C sfKeyEnter    equ 58
 = 00000000		      C sfKeyA        equ 0
 = 00000012		      C sfKeyS        equ 18
 = 00000003		      C sfKeyD        equ 3
 = 00000024		      C sfKeyEscape   equ 36
			      C 
			      C ; 視窗風格定義
 = 00000000		      C sfNone       equ 0
 = 00000001		      C sfTitlebar   equ 1
 = 00000002		      C sfResize     equ 2
 = 00000004		      C sfClose      equ 4
 = 00000008		      C sfFullscreen equ 8
			      C 
			      C ; 結構體定義
 00000008		      C sfVector2f STRUCT
 00000000  00000000	      C     x REAL4 ?
 00000004  00000000	      C     y REAL4 ?
			      C sfVector2f ENDS
			      C 
 00000008		      C sfVector2i STRUCT
 00000000  00000000	      C     x SDWORD ?
 00000004  00000000	      C     y SDWORD ?
			      C sfVector2i ENDS
			      C 
 0000000C		      C sfVideoMode STRUCT
 00000000  00000000	      C     _width  DWORD ?
 00000004  00000000	      C     height DWORD ?
 00000008  00000000	      C     bpp    DWORD ?
			      C sfVideoMode ENDS
			      C 
 00000004		      C sfColor STRUCT
 00000000  00		      C     r BYTE ?
 00000001  00		      C     g BYTE ?
 00000002  00		      C     b BYTE ?
 00000003  00		      C     a BYTE ?
			      C sfColor ENDS
			      C 
 00000010		      C sfFloatRect STRUCT
 00000000  00000000	      C     left   REAL4 ?
 00000004  00000000	      C     top    REAL4 ?
 00000008  00000000	      C     _width  REAL4 ?
 0000000C  00000000	      C     height REAL4 ?
			      C sfFloatRect ENDS
			      C 
 0000000C		      C mouseButton STRUCT
 00000000  00000000	      C     button DWORD ?
 00000004  00000000	      C     x DWORD ?
 00000008  00000000	      C     y DWORD ?
			      C mouseButton ENDS
			      C 
 00000014		      C key STRUCT
 00000000  00000000	      C     code DWORD ?
 00000004  00000000	      C     alt DWORD ?
 00000008  00000000	      C     control DWORD ?
 0000000C  00000000	      C     shift DWORD ?
 00000010  00000000	      C     system DWORD ?
			      C key ENDS
			      C 
 00000030		      C sfEvent STRUCT
 00000000  00000000	      C     _type DWORD ?                
 00000004  00000000	      C     _size DWORD ?                
 00000008  00000000	      C     mouse mouseButton <>       
	   00000000
	   00000000
 00000014  00000000	      C     _key key <>                 
	   00000000
	   00000000
	   00000000
	   00000000
 00000028  00000000	      C     mouseMove sfVector2i <>     
	   00000000
			      C sfEvent ENDS
			      C 
			      C ; 函數原型 - 視窗相關
			      C EXTERN sfRenderWindow_create:PROC
			      C EXTERN sfRenderWindow_destroy:PROC
			      C EXTERN sfRenderWindow_close:PROC
			      C EXTERN sfRenderWindow_isOpen:PROC
			      C EXTERN sfRenderWindow_clear:PROC
			      C EXTERN sfRenderWindow_display:PROC
			      C EXTERN sfRenderWindow_pollEvent:PROC
			      C EXTERN sfRenderWindow_drawSprite:PROC
			      C EXTERN sfRenderWindow_drawText:PROC
			      C 
			      C ; 函數原型 - 紋理相關
			      C EXTERN sfTexture_createFromFile:PROC
			      C EXTERN sfTexture_destroy:PROC
			      C 
			      C ; 函數原型 - 精靈相關
			      C EXTERN sfSprite_create:PROC
			      C EXTERN sfSprite_destroy:PROC
			      C EXTERN sfSprite_setTexture:PROC
			      C EXTERN sfSprite_setPosition:PROC
			      C EXTERN sfSprite_setOrigin:PROC
			      C EXTERN sfSprite_move:PROC
			      C 
			      C ; 函數原型 - 音樂相關
			      C EXTERN sfMusic_createFromFile:PROC
			      C EXTERN sfMusic_destroy:PROC
			      C EXTERN sfMusic_play:PROC
			      C EXTERN sfMusic_setLoop:PROC
			      C EXTERN sfMusic_stop: PROC
			      C EXTERN sfMusic_getStatus: PROC
			      C 
			      C ; 函數原型 - 文字相關
			      C EXTERN sfFont_createFromFile:PROC
			      C EXTERN sfFont_destroy:PROC
			      C EXTERN sfText_create:PROC
			      C EXTERN sfText_destroy:PROC
			      C EXTERN sfText_setFont:PROC
			      C EXTERN sfText_setString:PROC
			      C EXTERN sfText_setCharacterSize:PROC
			      C EXTERN sfText_setFillColor:PROC
			      C EXTERN sfText_setOutlineColor:PROC
			      C EXTERN sfText_setOutlineThickness:PROC
			      C EXTERN sfText_getLocalBounds:PROC
			      C EXTERN sfText_getGlobalBounds:PROC
			      C EXTERN sfText_setPosition:PROC
			      C 
			      C ; 函數原型 - 顏色相關
			      C EXTERN sfColor_fromRGB:PROC
			      C EXTERN sfColor_fromRGBA:PROC
			      C 
			      C ; 函數原型 - 矩形相關
			      C EXTERN sfRectangleShape_create: PROC
			      C EXTERN sfRectangleShape_setPosition: PROC
			      C EXTERN sfRectangleShape_setSize: PROC
			      C EXTERN sfRectangleShape_setFillColor: PROC
			      C EXTERN sfRectangleShape_setOutlineThickness: PROC
			      C EXTERN sfRenderWindow_drawRectangleShape: PROC
			      C EXTERN sfRectangleShape_destroy: PROC
			      C EXTERN sfRectangleShape_setOutlineColor: PROC
			      C 
			      C EXTERN sfSleep: PROC
			      C 
			      C EXTERN sfClock_create:PROC
			      C EXTERN sfClock_getElapsedTime:PROC
			      C EXTERN sfClock_restart:PROC
			      C EXTERN sfClock_destroy:PROC
			      C 
				include windows.inc
			      C ; windows.inc - 包含 Windows API 函數的定義
			      C 
			      C includelib kernel32.lib
			      C 
			      C extern GetStdHandle@4:PROC
			      C extern CreateFileA@28:PROC
			      C extern WriteFile@20:PROC
			      C extern ReadFile@20:PROC
			      C extern ExitProcess@4:PROC
			      C extern CloseHandle@4:PROC
			      C extern WriteConsoleA@20:PROC
			      C extern GetLastError@0:PROC
			      C 
			      C ; 定義常量
 = 0x80000000		      C GENERIC_READ         EQU 0x80000000
 = 0x00000001		      C FILE_SHARE_READ      EQU 0x00000001
 =-0000000B		      C STD_OUTPUT_HANDLE equ -11
 = 00000003		      C OPEN_EXISTING        EQU 3
 = 0x00000080		      C FILE_ATTRIBUTE_NORMAL EQU 0x00000080
			      C 
			      C 
			      C 
				includelib kernel32.lib
				includelib msvcrt.lib

				extern currentPage: DWORD
				extern end_game_page:PROC

 00000000			.data
				    ; 檔案路徑
 00000000 61 73 73 65 74	    bg_path db "assets/main/bg_genre_2.png", 0
	   73 2F 6D 61 69
	   6E 2F 62 67 5F
	   67 65 6E 72 65
	   5F 32 2E 70 6E
	   67 00
 0000001B 61 73 73 65 74	    red_note_path db "assets/main/red_note.png", 0
	   73 2F 6D 61 69
	   6E 2F 72 65 64
	   5F 6E 6F 74 65
	   2E 70 6E 67 00
 00000034 61 73 73 65 74	    blue_note_path db "assets/main/blue_note.png", 0
	   73 2F 6D 61 69
	   6E 2F 62 6C 75
	   65 5F 6E 6F 74
	   65 2E 70 6E 67
	   00


 0000004E 61 73 73 65 74	    selectedMusicPath db "assets/main/song1.ogg", 0
	   73 2F 6D 61 69
	   6E 2F 73 6F 6E
	   67 31 2E 6F 67
	   67 00
 00000064 61 73 73 65 74	    selectedBeatmapPath db "assets/main/song1.tja", 0
	   73 2F 6D 61 69
	   6E 2F 73 6F 6E
	   67 31 2E 74 6A
	   61 00
 0000007A 61 73 73 65 74	    red_note_sound_path db "assets/main/RedNote.wav", 0
	   73 2F 6D 61 69
	   6E 2F 52 65 64
	   4E 6F 74 65 2E
	   77 61 76 00
 00000092 61 73 73 65 74	    blue_note_sound_path db "assets/main/BlueNote.wav", 0
	   73 2F 6D 61 69
	   6E 2F 42 6C 75
	   65 4E 6F 74 65
	   2E 77 61 76 00

				    ; CSFML 物件
 000000AB 00000000		    bgTexture dd 0
 000000AF 00000000		    bgSprite dd 0
 000000B3 00000000		    redNoteTexture dd 0
 000000B7 00000000		    blueNoteTexture dd 0
 000000BB  00000100 [		    noteSprites dd 256 DUP(0) ; 最多支援 256 個音符精靈
	    00000000
	   ]
 000004BB 00000000		    noteCount dd 0            ; 當前音符數量
 000004BF 00000000		    bgmusic dd 0

				    ; 計時器
 000004C3 00000000		    clock dd 0
 000004C7 00000000		    note_timer REAL4 0.0       ; 音符生成計時器
 000004CB 44960000		    note_interval REAL4 1200.0    ; 每 1 秒生成一個音符

				    ; 視窗設定
 000004CF 00000500		    window_videoMode sfVideoMode <1280, 720, 32>
	   000002D0
	   00000020
 000004DB 54 61 69 6B 6F	    windowTitle db "Taiko Simulator", 0
	   20 53 69 6D 75
	   6C 61 74 6F 72
	   00
 000004EB BD4CCCCD		    scrollSpeed REAL4 -0.05      ; 音符滾動速度 (向左移動)

				    ; 事件結構
 000004EF 00000000		    event sfEvent <>
	   00000000
	   00000000
	   00000000
	   00000000
	   00000000
	   00000000
	   00000000
	   00000000
	   00000000
	   00000000
	   00000000

				    ; 確認鍵盤按鍵, 追蹤按鍵是否按下
 0000051F 00000000		    KeyA_state dd 0
 00000523 00000000		    KeyD_state dd 0
 00000527 00000000		    KeyS_state dd 0 ;   for testing

				    ; 顏色常數
 0000052B FF FF FF FF		    whiteColor sfColor <255, 255, 255, 255> ; 白色
 0000052F 00 00 00 FF		    blackColor sfColor <0, 0, 0, 255>       ; 黑色

 00000533 44960000		    notePosition sfVector2f <1200.0, 200.0>  ; 音符的 X 和 Y 座標
	   43480000
 0000053B BDCCCCCD		    movePosition sfVector2f <-0.1, 0.0>
	   00000000
 00000543  00000100 [		    notes db 256 DUP(0)
	    00
	   ]
 00000643 00000000		    totalNotes dd 0
 00000647 42E34CCD		    bpm REAL4 113.65
 0000064B 00000000		    noteSpawnInterval REAL4 0.0
 0000064F  00000100 [		    lineBuffer db 256 DUP(0)
	    00
	   ]
 0000074F 23 53 54 41 52	    startTag db "#START", 0
	   54 00
 00000756 23 45 4E 44 00	    endTag db "#END", 0
				    
				     ; 判定窗口 (以毫秒計)
 0000075B 00000023		    hitWindowGreat DWORD 35   ; "Great" 判定範圍
 0000075F 00000050		    hitWindowGood  DWORD 80   ; "Good" 判定範圍
 00000763 00000078		    hitWindowMiss  DWORD 120  ; "Miss" 判定範圍

				    ; 用來存great good miss 的次數和最後總分
 00000767 00000000		    great_count DWORD 0
 0000076B 00000000		    good_count DWORD 0
 0000076F 00000000		    miss_count DWORD 0
 00000773 00000000		    score DWORD 0

 00000000			.code
 00000000			game_play_music PROC
 00000000  68 0000004E R	    push offset selectedMusicPath
 00000005  E8 00000000 E	    call sfMusic_createFromFile
 0000000A  83 C4 04		    add esp, 4 
 0000000D  A3 000004BF R	    mov bgMusic, eax

 00000012  50			    push eax
 00000013  E8 00000000 E	    call sfMusic_play
 00000018  83 C4 04		    add esp, 4
 0000001B  C3			    ret
 0000001C			game_play_music ENDP

				; 載入背景
 0000001C			@load_bg PROC
				    ; 創建背景紋理
 0000001C  6A 00		    push 0
 0000001E  68 00000000 R	    push offset bg_path
 00000023  E8 00000000 E	    call sfTexture_createFromFile
 00000028  83 C4 08		    add esp, 8
 0000002B  85 C0		    test eax, eax
 0000002D  74 2B		    jz @fail_load
 0000002F  A3 000000AB R	    mov bgTexture, eax

				    ; 創建背景精靈
 00000034  E8 00000000 E	    call sfSprite_create
 00000039  85 C0		    test eax, eax
 0000003B  74 1D		    jz @fail_load
 0000003D  A3 000000AF R	    mov DWORD PTR [bgSprite], eax

				    ; 設定紋理
 00000042  6A 01		    push 1
 00000044  A1 000000AB R	    mov eax, DWORD PTR [bgTexture]
 00000049  50			    push eax
 0000004A  8B 0D 000000AF R	    mov ecx, DWORD PTR [bgSprite]
 00000050  51			    push ecx
 00000051  E8 00000000 E	    call sfSprite_setTexture
 00000056  83 C4 0C		    add esp, 12
 00000059  C3			    ret

 0000005A			@fail_load:
 0000005A  B8 00000000		    mov eax, 0
 0000005F  C3			    ret
 00000060			@load_bg ENDP





				; 載入音符
 00000060			@load_notes PROC
				    ; 創建紅色音符紋理
 00000060  6A 00		    push 0
 00000062  68 0000001B R	    push offset red_note_path
 00000067  E8 00000000 E	    call sfTexture_createFromFile
 0000006C  83 C4 08		    add esp, 8
 0000006F  85 C0		    test eax, eax
 00000071  74 06		    jz @fail_load
 00000073  A3 000000B3 R	    mov redNoteTexture, eax
 00000078  C3			    ret

 00000079			@fail_load:
 00000079  B8 00000000		    mov eax, 0
 0000007E  C3			    ret
 0000007F			@load_notes ENDP

 0000007F			@read_beatmap PROC


 0000007F			    @end:
 0000007F  C3			        ret

 00000080			@read_beatmap ENDP

				; 生成新的音符
 00000080			@generate_note PROC
				    ; 如果音符超過最大數量，則跳過
 00000080  A1 000004BB R	    mov eax, noteCount
 00000085  3D 00000100		    cmp eax, 256   ; 生成最多 256 個音符
 0000008A  73 50		    jae @end

				    ; 創建新的音符精靈
 0000008C  E8 00000000 E	    call sfSprite_create
 00000091  85 C0		    test eax, eax
 00000093  74 47		    jz @end

				    ; 將新的音符精靈儲存到陣列中
 00000095  8B 35 000004BB R	    mov esi, noteCount           ; 使用 noteCount 來確保索引有效
 0000009B  89 04 B5		    mov DWORD PTR [noteSprites + esi*4], eax
	   000000BB R

				    ; 設定紅色音符紋理
 000000A2  6A 01		    push 1
 000000A4  A1 000000B3 R	    mov eax, redNoteTexture
 000000A9  50			    push eax
 000000AA  8B 0C B5		    mov ecx, DWORD PTR [noteSprites + esi*4]
	   000000BB R
 000000B1  51			    push ecx
 000000B2  E8 00000000 E	    call sfSprite_setTexture
 000000B7  83 C4 0C		    add esp, 12

				    ; 設定音符初始位置
 000000BA  FF 35 00000537 R	    push dword ptr [notePosition+4] ; Y 座標
 000000C0  FF 35 00000533 R	    push dword ptr [notePosition]   ; X 座標
 000000C6  8B 04 B5		    mov eax, DWORD PTR [noteSprites + esi*4]
	   000000BB R
 000000CD  50			    push eax
 000000CE  E8 00000000 E	    call sfSprite_setPosition
 000000D3  83 C4 0C		    add esp, 12

				    ; 更新音符數量
 000000D6  FF 05 000004BB R	    inc noteCount

 000000DC			    @end:
 000000DC  C3			        ret

 000000DD			@generate_note ENDP

				; 更新音符位置
 000000DD			@update_notes PROC
 000000DD  33 F6    xor esi, esi

 000000DF			@loop_notes:
 000000DF  3B 35 000004BB R	    cmp esi, noteCount
 000000E5  7D 23		    jge @end

				    ; 檢查音符是否有效
 000000E7  8B 04 B5		    mov eax, DWORD PTR [noteSprites + esi*4]
	   000000BB R
 000000EE  85 C0		    test eax, eax
 000000F0  74 15		    jz @next_note

				    ; 移動音符
 000000F2  FF 35 0000053F R	    push dword ptr [movePosition+4] ; Y 方向不變
 000000F8  FF 35 000004EB R	    push scrollSpeed                ; X 方向移動
 000000FE  50			    push eax
 000000FF  E8 00000000 E	    call sfSprite_move
 00000104  83 C4 0C		    add esp, 12

 00000107			@next_note:
 00000107  46			    inc esi
 00000108  EB D5		    jmp @loop_notes
 0000010A			@end:
 0000010A  C3			    ret
 0000010B			@update_notes ENDP

				; 清理音符
 0000010B			@cleanup_notes PROC
 0000010B  33 F6		    xor esi, esi

 0000010D			@loop_cleanup:
 0000010D  3B 35 000004BB R	    cmp esi, noteCount
 00000113  7D 17		    jge @end

				    ; 檢查音符是否有效
 00000115  8B 04 B5		    mov eax, DWORD PTR [noteSprites + esi*4]
	   000000BB R
 0000011C  85 C0		    test eax, eax
 0000011E  74 09		    jz @next_cleanup

				    ; 銷毀音符精靈
 00000120  50			    push eax
 00000121  E8 00000000 E	    call sfSprite_destroy
 00000126  83 C4 04		    add esp, 4

 00000129			@next_cleanup:
 00000129  46			    inc esi
 0000012A  EB E1		    jmp @loop_cleanup

 0000012C			@end:
 0000012C  C3			    ret
 0000012D			@cleanup_notes ENDP

 0000012D			rednote_sound PROC
 0000012D  68 0000007A R	    push offset red_note_sound_path
 00000132  E8 00000000 E	    call sfMusic_createFromFile
 00000137  83 C4 04		    add esp, 4 
 0000013A  A3 000004BF R	    mov bgMusic, eax

 0000013F  50			    push eax
 00000140  E8 00000000 E	    call sfMusic_play
 00000145  83 C4 04		    add esp, 4
 00000148  C3			    ret
 00000149			rednote_sound ENDP

 00000149			bluenote_sound PROC
 00000149  68 00000092 R	    push offset blue_note_sound_path
 0000014E  E8 00000000 E	    call sfMusic_createFromFile
 00000153  83 C4 04		    add esp, 4 
 00000156  A3 000004BF R	    mov bgMusic, eax

 0000015B  50			    push eax
 0000015C  E8 00000000 E	    call sfMusic_play
 00000161  83 C4 04		    add esp, 4
 00000164  C3			    ret
 00000165			bluenote_sound ENDP

 00000165			main_game_page PROC window:DWORD
				    ; 載入背景
 00000168  E8 FFFFFEAF		    call @load_bg
 0000016D  85 C0		    test eax, eax
 0000016F  0F 84 000001E5	    jz @exit_program

				    ; 播放音樂
 00000175  E8 FFFFFE86		    call game_play_music

				    ; 載入音符
 0000017A  E8 FFFFFEE1		    call @load_notes
 0000017F  85 C0		    test eax, eax
 00000181  0F 84 000001D3	    jz @exit_program

				    ; 初始化計時器
 00000187  E8 00000000 E	    call sfClock_create
 0000018C  85 C0		    test eax, eax
 0000018E  0F 84 000001C6	    jz @exit_program
 00000194  A3 000004C3 R	    mov clock, eax

				    ; 設置音符生成間隔開始時間
 00000199  F3/ 0F 11 05		    movss note_timer, xmm0
	   000004C7 R

 000001A1			@main_loop:
				    ; 檢查視窗是否開啟
 000001A1  8B 45 08		    mov eax, window
 000001A4  50			    push eax
 000001A5  E8 00000000 E	    call sfRenderWindow_isOpen
 000001AA  83 C4 04		    add esp, 4
 000001AD  85 C0		    test eax, eax
 000001AF  0F 84 000001A5	    je @exit_program


				    ; 更新計時器
 000001B5  A1 000004C3 R	    mov eax, clock
 000001BA  50			    push eax
 000001BB  E8 00000000 E	    call sfClock_getElapsedTime
 000001C0  83 C4 04		    add esp, 4
 000001C3  85 C0		    test eax, eax
 000001C5  0F 84 0000018F	    jz @exit_program               ; 如果時間返回無效，退出程式

				    ; 檢查音樂是否停止
 000001CB  FF 35 000004BF R	    push bgMusic
 000001D1  E8 00000000 E	    call sfMusic_getStatus
 000001D6  83 C4 04		    add esp, 4
 000001D9  83 F8 00		    cmp eax, 0
 000001DC  0F 84 00000149	    je @to_end_page

				    ; 提取微秒並轉換為秒數
 000001E2  BB 000F4240		    mov ebx, 1000000  ; 1,000,000 用於將微秒轉換為秒
 000001E7  33 D2		    xor edx, edx      ; 清除 edx，準備進行除法操作
 000001E9  F7 F3		    div ebx           ; eax = microseconds / 1,000,000 (秒數)
 000001EB  F3/ 0F 11 05		    movss note_timer, xmm0  ; 將秒數存儲到 note_timer
	   000004C7 R

				    ; 判斷是否生成新的音符
 000001F3  F3/ 0F 10 05		    movss xmm0, note_timer
	   000004C7 R
 000001FB  F3/ 0F 10 0D		    movss xmm1, note_interval
	   000004CB R
 00000203  0F 2F C1		    comiss xmm0, xmm1
 00000206  0F 82 000000BD	    jb @skip_generate_note

				    ; 生成音符並重置計時器
 0000020C  E8 FFFFFE6F		    call @generate_note
 00000211  E8 00000000 E	    call sfClock_restart           ; 重置時鐘

 00000216			    @event_loop:
				        ; 事件處理
 00000216  8D 35 000004EF R	        lea esi, event
 0000021C  56			        push esi
 0000021D  8B 45 08		        mov eax, window
 00000220  50			        push eax
 00000221  E8 00000000 E	        call sfRenderWindow_pollEvent
 00000226  83 C4 08		        add esp, 8
 00000229  85 C0		        test eax, eax
 0000022B  0F 84 00000098	        je @skip_generate_note
				    
				        ; 檢查關閉事件
 00000231  83 3E 00		        cmp dword ptr [esi].sfEvent._type, sfEvtClosed
 00000234  0F 84 000000F1	        je @to_end_page

				        ; 檢查滑鼠點擊
 0000023A  83 3E 09		        cmp dword ptr [esi].sfEvent._type, sfEvtMouseButtonPressed
 0000023D  0F 84 00000086	        je @skip_generate_note
				    
				        ; 檢查鍵盤事件
 00000243  83 3E 05		        cmp dword ptr [esi].sfEvent._type, sfEvtKeyPressed
 00000246  74 02		        je @check_key_press

 00000248  EB CC		        jmp @event_loop

 0000024A			        @check_key_press:
 0000024A  83 7E 04 00		            cmp dword ptr [esi+4], sfKeyA
 0000024E  74 08		            je @key_A_pressed

 00000250  83 7E 04 03		            cmp dword ptr [esi+4], sfKeyD
 00000254  74 51		            je @key_D_pressed 
				            
 00000256  EB BE		            jmp @event_loop

 00000258			@key_A_pressed:
 00000258  C7 05 0000051F R	    mov dword ptr [KeyA_state], 1 ; 設定狀態已按下 
	   00000001
 00000262  C7 05 00000523 R	    mov dword ptr [KeyD_state], 0
	   00000000
 0000026C  E8 FFFFFEBC		    call rednote_sound
 00000271  50			    push eax
 00000272  83 C4 04		    add esp, 4
				    ; delete the the latest note
 00000275  E9 FFFFFF27		    jmp @main_loop

 0000027A			@key_S_pressed:
 0000027A  C7 05 00000527 R	    mov dword ptr [KeyS_state], 1 ; 設定狀態已按下
	   00000001
 00000284  C7 05 0000051F R	    mov dword ptr [KeyA_state], 0
	   00000000
 0000028E  C7 05 00000523 R	   mov dword ptr [KeyD_state], 0
	   00000000
 00000298  C7 05 00000000 E	    mov DWORD PTR [currentPage], 3
	   00000003
 000002A2  E9 00000084		    jmp @to_end_page


 000002A7			@key_D_pressed:
 000002A7  C7 05 00000523 R	    mov dword ptr [KeyD_state], 1 ; 設定狀態已按下
	   00000001
 000002B1  C7 05 0000051F R	    mov dword ptr [KeyA_state], 0
	   00000000
 000002BB  E8 FFFFFE89		    call bluenote_sound
 000002C0  50			    push eax
 000002C1  83 C4 04		    add esp, 4
				    ; delete the the latest note
 000002C4  E9 FFFFFED8		    jmp @main_loop
				       

 000002C9			@skip_generate_note:
				    ; 更新音符
 000002C9  E8 FFFFFE0F		    call @update_notes

				    ; 清除視窗
 000002CE  FF 35 0000052F R	    push blackColor
 000002D4  FF 75 08		    push window
 000002D7  E8 00000000 E	    call sfRenderWindow_clear
 000002DC  83 C4 08		    add esp, 8

				    ; 繪製背景
 000002DF  6A 00		    push 0
 000002E1  A1 000000AF R	    mov eax, bgSprite
 000002E6  50			    push eax
 000002E7  8B 4D 08		    mov ecx, window
 000002EA  51			    push ecx
 000002EB  E8 00000000 E	    call sfRenderWindow_drawSprite
 000002F0  83 C4 0C		    add esp, 12

				    ; 繪製音符
 000002F3  33 F6		    xor esi, esi
 000002F5			@draw_notes_loop:
 000002F5  3B 35 000004BB R	    cmp esi, noteCount
 000002FB  7D 1D		    jge @end_draw_notes

 000002FD  8B 04 B5		    mov eax, DWORD PTR [noteSprites + esi*4]
	   000000BB R
 00000304  85 C0		    test eax, eax
 00000306  74 0F		    jz @next_draw

 00000308  6A 00		    push 0
 0000030A  50			    push eax
 0000030B  8B 4D 08		    mov ecx, window
 0000030E  51			    push ecx
 0000030F  E8 00000000 E	    call sfRenderWindow_drawSprite
 00000314  83 C4 0C		    add esp, 12

 00000317			@next_draw:
 00000317  46			    inc esi
 00000318  EB DB		    jmp @draw_notes_loop
 0000031A			@end_draw_notes:

				    ; 顯示視窗
 0000031A  8B 45 08		    mov eax, window
 0000031D  50			    push eax
 0000031E  E8 00000000 E	    call sfRenderWindow_display
 00000323  83 C4 04		    add esp, 4

 00000326  E9 FFFFFE76		    jmp @main_loop

				; 準備結算
 0000032B			@to_end_page:

 0000032B  FF 35 00000773 R	    push score    
 00000331  FF 35 0000076F R	    push miss_count    
 00000337  FF 35 0000076B R	    push good_count   
 0000033D  FF 35 00000767 R	    push great_count    
 00000343  FF 75 08		    push window       
 00000346  C7 05 00000000 E	    mov DWORD PTR [currentPage], 2      ;遊戲結束要切換到結尾畫面
	   00000002
 00000350  E8 00000000 E	    call end_game_page
 00000355  83 C4 14		    add esp, 20
 00000358  EB 00		    jmp @exit_program



 0000035A			@exit_program:
 0000035A  E8 FFFFFDAC		    call @cleanup_notes

 0000035F  FF 35 000000AF R	    push bgSprite
 00000365  E8 00000000 E	    call sfSprite_destroy
 0000036A  83 C4 04		    add esp, 4

 0000036D  FF 35 000000AB R	    push bgTexture
 00000373  E8 00000000 E	    call sfTexture_destroy
 00000378  83 C4 04		    add esp, 4

 0000037B  FF 35 000000B3 R	    push redNoteTexture
 00000381  E8 00000000 E	    call sfTexture_destroy
 00000386  83 C4 04		    add esp, 4

 00000389  FF 35 000004C3 R	    push clock
 0000038F  E8 00000000 E	    call sfClock_destroy
 00000394  83 C4 04		    add esp, 4




				    ret
 00000399			main_game_page ENDP

				END main_game_page
Microsoft (R) Macro Assembler Version 14.42.34435.0	    12/20/24 02:55:39
main_game_page.asm					     Symbols 2 - 1




Structures and Unions:

                N a m e                  Size
                                         Offset      Type

key  . . . . . . . . . . . . . .	 00000014
  code . . . . . . . . . . . . .	 00000000	 DWord
  alt  . . . . . . . . . . . . .	 00000004	 DWord
  control  . . . . . . . . . . .	 00000008	 DWord
  shift  . . . . . . . . . . . .	 0000000C	 DWord
  system . . . . . . . . . . . .	 00000010	 DWord
mouseButton  . . . . . . . . . .	 0000000C
  button . . . . . . . . . . . .	 00000000	 DWord
  x  . . . . . . . . . . . . . .	 00000004	 DWord
  y  . . . . . . . . . . . . . .	 00000008	 DWord
sfColor  . . . . . . . . . . . .	 00000004
  r  . . . . . . . . . . . . . .	 00000000	 Byte
  g  . . . . . . . . . . . . . .	 00000001	 Byte
  b  . . . . . . . . . . . . . .	 00000002	 Byte
  a  . . . . . . . . . . . . . .	 00000003	 Byte
sfEvent  . . . . . . . . . . . .	 00000030
  _type  . . . . . . . . . . . .	 00000000	 DWord
  _size  . . . . . . . . . . . .	 00000004	 DWord
  mouse  . . . . . . . . . . . .	 00000008	 
  _key . . . . . . . . . . . . .	 00000014	 
  mouseMove  . . . . . . . . . .	 00000028	 QWord
sfFloatRect  . . . . . . . . . .	 00000010
  left . . . . . . . . . . . . .	 00000000	 DWord
  top  . . . . . . . . . . . . .	 00000004	 DWord
  _width . . . . . . . . . . . .	 00000008	 DWord
  height . . . . . . . . . . . .	 0000000C	 DWord
sfVector2f . . . . . . . . . . .	 00000008
  x  . . . . . . . . . . . . . .	 00000000	 DWord
  y  . . . . . . . . . . . . . .	 00000004	 DWord
sfVector2i . . . . . . . . . . .	 00000008
  x  . . . . . . . . . . . . . .	 00000000	 DWord
  y  . . . . . . . . . . . . . .	 00000004	 DWord
sfVideoMode  . . . . . . . . . .	 0000000C
  _width . . . . . . . . . . . .	 00000000	 DWord
  height . . . . . . . . . . . .	 00000004	 DWord
  bpp  . . . . . . . . . . . . .	 00000008	 DWord


Segments and Groups:

                N a m e                 Size     Length   Align   Combine Class

FLAT . . . . . . . . . . . . . .	GROUP
_DATA  . . . . . . . . . . . . .	32 Bit	 00000777 Para	  Public  'DATA'	
_TEXT  . . . . . . . . . . . . .	32 Bit	 00000399 Para	  Public  'CODE'	


Procedures, parameters, and locals:

                N a m e                 Type     Value    Attr

@cleanup_notes . . . . . . . . .	P Near	 0000010B _TEXT	Length= 00000022 Public C
  @loop_cleanup  . . . . . . . .	L Near	 0000010D _TEXT	
  @next_cleanup  . . . . . . . .	L Near	 00000129 _TEXT	
  @end . . . . . . . . . . . . .	L Near	 0000012C _TEXT	
@generate_note . . . . . . . . .	P Near	 00000080 _TEXT	Length= 0000005D Public C
  @end . . . . . . . . . . . . .	L Near	 000000DC _TEXT	
@load_bg . . . . . . . . . . . .	P Near	 0000001C _TEXT	Length= 00000044 Public C
  @fail_load . . . . . . . . . .	L Near	 0000005A _TEXT	
@load_notes  . . . . . . . . . .	P Near	 00000060 _TEXT	Length= 0000001F Public C
  @fail_load . . . . . . . . . .	L Near	 00000079 _TEXT	
@read_beatmap  . . . . . . . . .	P Near	 0000007F _TEXT	Length= 00000001 Public C
  @end . . . . . . . . . . . . .	L Near	 0000007F _TEXT	
@update_notes  . . . . . . . . .	P Near	 000000DD _TEXT	Length= 0000002E Public C
  @loop_notes  . . . . . . . . .	L Near	 000000DF _TEXT	
  @next_note . . . . . . . . . .	L Near	 00000107 _TEXT	
  @end . . . . . . . . . . . . .	L Near	 0000010A _TEXT	
bluenote_sound . . . . . . . . .	P Near	 00000149 _TEXT	Length= 0000001C Public C
game_play_music  . . . . . . . .	P Near	 00000000 _TEXT	Length= 0000001C Public C
main_game_page . . . . . . . . .	P Near	 00000165 _TEXT	Length= 00000234 Public C
  window . . . . . . . . . . . .	DWord	 bp + 00000008
  @main_loop . . . . . . . . . .	L Near	 000001A1 _TEXT	
  @event_loop  . . . . . . . . .	L Near	 00000216 _TEXT	
  @check_key_press . . . . . . .	L Near	 0000024A _TEXT	
  @key_A_pressed . . . . . . . .	L Near	 00000258 _TEXT	
  @key_S_pressed . . . . . . . .	L Near	 0000027A _TEXT	
  @key_D_pressed . . . . . . . .	L Near	 000002A7 _TEXT	
  @skip_generate_note  . . . . .	L Near	 000002C9 _TEXT	
  @draw_notes_loop . . . . . . .	L Near	 000002F5 _TEXT	
  @next_draw . . . . . . . . . .	L Near	 00000317 _TEXT	
  @end_draw_notes  . . . . . . .	L Near	 0000031A _TEXT	
  @to_end_page . . . . . . . . .	L Near	 0000032B _TEXT	
  @exit_program  . . . . . . . .	L Near	 0000035A _TEXT	
rednote_sound  . . . . . . . . .	P Near	 0000012D _TEXT	Length= 0000001C Public C


Symbols:

                N a m e                 Type     Value    Attr

@CodeSize  . . . . . . . . . . .	Number	 00000000h   
@DataSize  . . . . . . . . . . .	Number	 00000000h   
@Interface . . . . . . . . . . .	Number	 00000001h   
@Model . . . . . . . . . . . . .	Number	 00000007h   
@code  . . . . . . . . . . . . .	Text   	 _TEXT
@data  . . . . . . . . . . . . .	Text   	 FLAT
@fardata?  . . . . . . . . . . .	Text   	 FLAT
@fardata . . . . . . . . . . . .	Text   	 FLAT
@stack . . . . . . . . . . . . .	Text   	 FLAT
CloseHandle@4  . . . . . . . . .	L Near	 00000000 FLAT	External C
CreateFileA@28 . . . . . . . . .	L Near	 00000000 FLAT	External C
ExitProcess@4  . . . . . . . . .	L Near	 00000000 FLAT	External C
FILE_ATTRIBUTE_NORMAL  . . . . .	Text   	 0x00000080
FILE_SHARE_READ  . . . . . . . .	Text   	 0x00000001
GENERIC_READ . . . . . . . . . .	Text   	 0x80000000
GetLastError@0 . . . . . . . . .	L Near	 00000000 FLAT	External C
GetStdHandle@4 . . . . . . . . .	L Near	 00000000 FLAT	External C
KeyA_state . . . . . . . . . . .	DWord	 0000051F _DATA	
KeyD_state . . . . . . . . . . .	DWord	 00000523 _DATA	
KeyS_state . . . . . . . . . . .	DWord	 00000527 _DATA	
OPEN_EXISTING  . . . . . . . . .	Number	 00000003h   
ReadFile@20  . . . . . . . . . .	L Near	 00000000 FLAT	External C
STD_OUTPUT_HANDLE  . . . . . . .	Number	 -0000000Bh   
WriteConsoleA@20 . . . . . . . .	L Near	 00000000 FLAT	External C
WriteFile@20 . . . . . . . . . .	L Near	 00000000 FLAT	External C
bgSprite . . . . . . . . . . . .	DWord	 000000AF _DATA	
bgTexture  . . . . . . . . . . .	DWord	 000000AB _DATA	
bg_path  . . . . . . . . . . . .	Byte	 00000000 _DATA	
bgmusic  . . . . . . . . . . . .	DWord	 000004BF _DATA	
blackColor . . . . . . . . . . .	sfColor	 0000052F _DATA	
blueNoteTexture  . . . . . . . .	DWord	 000000B7 _DATA	
blue_note_path . . . . . . . . .	Byte	 00000034 _DATA	
blue_note_sound_path . . . . . .	Byte	 00000092 _DATA	
bpm  . . . . . . . . . . . . . .	DWord	 00000647 _DATA	
clock  . . . . . . . . . . . . .	DWord	 000004C3 _DATA	
currentPage  . . . . . . . . . .	DWord	 00000000 FLAT	External C
endTag . . . . . . . . . . . . .	Byte	 00000756 _DATA	
end_game_page  . . . . . . . . .	L Near	 00000000 FLAT	External C
event  . . . . . . . . . . . . .	sfEvent	 000004EF _DATA	
good_count . . . . . . . . . . .	DWord	 0000076B _DATA	
great_count  . . . . . . . . . .	DWord	 00000767 _DATA	
hitWindowGood  . . . . . . . . .	DWord	 0000075F _DATA	
hitWindowGreat . . . . . . . . .	DWord	 0000075B _DATA	
hitWindowMiss  . . . . . . . . .	DWord	 00000763 _DATA	
lineBuffer . . . . . . . . . . .	Byte	 0000064F _DATA	
miss_count . . . . . . . . . . .	DWord	 0000076F _DATA	
movePosition . . . . . . . . . .	sfVector2f  0000053B _DATA	
noteCount  . . . . . . . . . . .	DWord	 000004BB _DATA	
notePosition . . . . . . . . . .	sfVector2f  00000533 _DATA	
noteSpawnInterval  . . . . . . .	DWord	 0000064B _DATA	
noteSprites  . . . . . . . . . .	DWord	 000000BB _DATA	
note_interval  . . . . . . . . .	DWord	 000004CB _DATA	
note_timer . . . . . . . . . . .	DWord	 000004C7 _DATA	
notes  . . . . . . . . . . . . .	Byte	 00000543 _DATA	
redNoteTexture . . . . . . . . .	DWord	 000000B3 _DATA	
red_note_path  . . . . . . . . .	Byte	 0000001B _DATA	
red_note_sound_path  . . . . . .	Byte	 0000007A _DATA	
score  . . . . . . . . . . . . .	DWord	 00000773 _DATA	
scrollSpeed  . . . . . . . . . .	DWord	 000004EB _DATA	
selectedBeatmapPath  . . . . . .	Byte	 00000064 _DATA	
selectedMusicPath  . . . . . . .	Byte	 0000004E _DATA	
sfClock_create . . . . . . . . .	L Near	 00000000 FLAT	External C
sfClock_destroy  . . . . . . . .	L Near	 00000000 FLAT	External C
sfClock_getElapsedTime . . . . .	L Near	 00000000 FLAT	External C
sfClock_restart  . . . . . . . .	L Near	 00000000 FLAT	External C
sfClose  . . . . . . . . . . . .	Number	 00000004h   
sfColor_fromRGBA . . . . . . . .	L Near	 00000000 FLAT	External C
sfColor_fromRGB  . . . . . . . .	L Near	 00000000 FLAT	External C
sfEvtClosed  . . . . . . . . . .	Number	 00000000h   
sfEvtGainedFocus . . . . . . . .	Number	 00000003h   
sfEvtKeyPressed  . . . . . . . .	Number	 00000005h   
sfEvtKeyReleased . . . . . . . .	Number	 00000006h   
sfEvtLostFocus . . . . . . . . .	Number	 00000002h   
sfEvtMouseButtonPressed  . . . .	Number	 00000009h   
sfEvtMouseButtonReleased . . . .	Number	 0000000Ah   
sfEvtMouseEntered  . . . . . . .	Number	 0000000Ch   
sfEvtMouseLeft . . . . . . . . .	Number	 0000000Dh   
sfEvtMouseMoved  . . . . . . . .	Number	 0000000Bh   
sfEvtMouseWheelMoved . . . . . .	Number	 00000007h   
sfEvtMouseWheelScrolled  . . . .	Number	 00000008h   
sfEvtResized . . . . . . . . . .	Number	 00000001h   
sfEvtTextEntered . . . . . . . .	Number	 00000004h   
sfFalse  . . . . . . . . . . . .	Number	 00000000h   
sfFont_createFromFile  . . . . .	L Near	 00000000 FLAT	External C
sfFont_destroy . . . . . . . . .	L Near	 00000000 FLAT	External C
sfFullscreen . . . . . . . . . .	Number	 00000008h   
sfKeyA . . . . . . . . . . . . .	Number	 00000000h   
sfKeyD . . . . . . . . . . . . .	Number	 00000003h   
sfKeyEnter . . . . . . . . . . .	Number	 0000003Ah   
sfKeyEscape  . . . . . . . . . .	Number	 00000024h   
sfKeyS . . . . . . . . . . . . .	Number	 00000012h   
sfMouseLeft  . . . . . . . . . .	Number	 00000000h   
sfMouseMiddle  . . . . . . . . .	Number	 00000002h   
sfMouseRight . . . . . . . . . .	Number	 00000001h   
sfMusic_createFromFile . . . . .	L Near	 00000000 FLAT	External C
sfMusic_destroy  . . . . . . . .	L Near	 00000000 FLAT	External C
sfMusic_getStatus  . . . . . . .	L Near	 00000000 FLAT	External C
sfMusic_play . . . . . . . . . .	L Near	 00000000 FLAT	External C
sfMusic_setLoop  . . . . . . . .	L Near	 00000000 FLAT	External C
sfMusic_stop . . . . . . . . . .	L Near	 00000000 FLAT	External C
sfNone . . . . . . . . . . . . .	Number	 00000000h   
sfRectangleShape_create  . . . .	L Near	 00000000 FLAT	External C
sfRectangleShape_destroy . . . .	L Near	 00000000 FLAT	External C
sfRectangleShape_setFillColor  .	L Near	 00000000 FLAT	External C
sfRectangleShape_setOutlineColor .	L Near	 00000000 FLAT	External C
sfRectangleShape_setOutlineThickness .	L Near	 00000000 FLAT	External C
sfRectangleShape_setPosition . .	L Near	 00000000 FLAT	External C
sfRectangleShape_setSize . . . .	L Near	 00000000 FLAT	External C
sfRenderWindow_clear . . . . . .	L Near	 00000000 FLAT	External C
sfRenderWindow_close . . . . . .	L Near	 00000000 FLAT	External C
sfRenderWindow_create  . . . . .	L Near	 00000000 FLAT	External C
sfRenderWindow_destroy . . . . .	L Near	 00000000 FLAT	External C
sfRenderWindow_display . . . . .	L Near	 00000000 FLAT	External C
sfRenderWindow_drawRectangleShape 	L Near	 00000000 FLAT	External C
sfRenderWindow_drawSprite  . . .	L Near	 00000000 FLAT	External C
sfRenderWindow_drawText  . . . .	L Near	 00000000 FLAT	External C
sfRenderWindow_isOpen  . . . . .	L Near	 00000000 FLAT	External C
sfRenderWindow_pollEvent . . . .	L Near	 00000000 FLAT	External C
sfResize . . . . . . . . . . . .	Number	 00000002h   
sfSleep  . . . . . . . . . . . .	L Near	 00000000 FLAT	External C
sfSprite_create  . . . . . . . .	L Near	 00000000 FLAT	External C
sfSprite_destroy . . . . . . . .	L Near	 00000000 FLAT	External C
sfSprite_move  . . . . . . . . .	L Near	 00000000 FLAT	External C
sfSprite_setOrigin . . . . . . .	L Near	 00000000 FLAT	External C
sfSprite_setPosition . . . . . .	L Near	 00000000 FLAT	External C
sfSprite_setTexture  . . . . . .	L Near	 00000000 FLAT	External C
sfText_create  . . . . . . . . .	L Near	 00000000 FLAT	External C
sfText_destroy . . . . . . . . .	L Near	 00000000 FLAT	External C
sfText_getGlobalBounds . . . . .	L Near	 00000000 FLAT	External C
sfText_getLocalBounds  . . . . .	L Near	 00000000 FLAT	External C
sfText_setCharacterSize  . . . .	L Near	 00000000 FLAT	External C
sfText_setFillColor  . . . . . .	L Near	 00000000 FLAT	External C
sfText_setFont . . . . . . . . .	L Near	 00000000 FLAT	External C
sfText_setOutlineColor . . . . .	L Near	 00000000 FLAT	External C
sfText_setOutlineThickness . . .	L Near	 00000000 FLAT	External C
sfText_setPosition . . . . . . .	L Near	 00000000 FLAT	External C
sfText_setString . . . . . . . .	L Near	 00000000 FLAT	External C
sfTexture_createFromFile . . . .	L Near	 00000000 FLAT	External C
sfTexture_destroy  . . . . . . .	L Near	 00000000 FLAT	External C
sfTitlebar . . . . . . . . . . .	Number	 00000001h   
sfTrue . . . . . . . . . . . . .	Number	 00000001h   
startTag . . . . . . . . . . . .	Byte	 0000074F _DATA	
totalNotes . . . . . . . . . . .	DWord	 00000643 _DATA	
whiteColor . . . . . . . . . . .	sfColor	 0000052B _DATA	
windowTitle  . . . . . . . . . .	Byte	 000004DB _DATA	
window_videoMode . . . . . . . .	sfVideoMode  000004CF _DATA	

	   0 Warnings
	   0 Errors
